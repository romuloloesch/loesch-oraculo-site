
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel Oracular v1 â€” AutÃ´nomo</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">â–³ Painel Oracular v1 â€” <span class="badge">NÃºcleo AutÃ´nomo</span></div>
      <div class="badge">Tema Oracular aplicado</div>
    </div>

    <div class="controls">
      <label>PerÃ­odo: <input type="date" id="dtIni"> â€” <input type="date" id="dtFim"></label>
      <label>Dispositivo:
        <select id="selDisp"><option>Todos</option><option>desktop</option><option>mobile</option><option>tablet</option></select>
      </label>
      <label>PaÃ­s:
        <select id="selPais"><option>Todos</option><option>BR</option><option>US</option><option>AR</option><option>PY</option></select>
      </label>
      <button id="btnAtualizar">ðŸ”„ Atualizar Base de Dados</button>
    </div>

    <div class="kpis">
      <div class="card">
        <small>ImpressÃµes (30d)<span id="impressoes"></span><span id="impressoes"></span></small>
        <div id="kpi-impr" style="font-size:28px;font-weight:800">â€”</div>
        <div class="muted" id="delta-impr">â€”</div>
      </div>
      <div class="card">
        <small>Cliques (30d)<span id="cliques"></span><span id="cliques"></span></small>
        <div id="kpi-cliques" style="font-size:28px;font-weight:800">â€”</div>
        <div class="muted" id="delta-cliques">â€”</div>
      </div>
      <div class="card">
        <small>CTR mÃ©dio<span id="ctr"></span><span id="ctr"></span></small>
        <div id="kpi-ctr" style="font-size:28px;font-weight:800">â€”</div>
        <div class="muted" id="delta-ctr">â€”</div>
      </div>
      <div class="card">
        <small>PosiÃ§Ã£o mÃ©dia<span id="posicao"></span><span id="posicao"></span></small>
        <div id="kpi-pos" style="font-size:28px;font-weight:800">â€”</div>
        <div class="muted" id="delta-pos">â€”</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <small>TendÃªncia â€” Cliques Ã— ImpressÃµes Ã— CTR</small>
        <canvas id="chart-serie" height="160"></canvas>
      </div>
      <div class="card">
        <small>Dispositivos</small>
        <canvas id="chart-donut" height="160"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <small>Principais paÃ­ses</small>
      <table class="table">
        <thead>
          <tr><th>PaÃ­s</th><th>ImpressÃµes</th><th>Cliques</th><th>CTR</th></tr>
        </thead>
        <tbody id="tbody-paises"></tbody>
      </table>
    </div>

    <div class="footer">
      <div>Ãšltima atualizaÃ§Ã£o: <span id="ultima-atualizacao">â€”</span></div>
      <div class="muted">PerÃ­odo base: <span id="periodo">â€”</span></div>
      <div class="muted">Fonte: dados_oraculares.json</div>
    </div>
  </div>

  <script src="painel.js"></script>
</body>
</html>
<script>
function setText(sel, val){ const el=document.querySelector(sel); if(el) el.innerHTML = `<strong>${val}</strong>`; }

function drawTrend(hist){
  const box = document.getElementById('trend');
  if(!box){ return; }
  const w = box.clientWidth || 820, h = 200, p = 24;
  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('width', w); svg.setAttribute('height', h); svg.style.display='block';

  const n = hist.length || 0;
  const maxImp = Math.max(1, ...hist.map(d=>d.impressoes));
  const maxClk = Math.max(1, ...hist.map(d=>d.cliques));
  const maxCtr = Math.max(1, ...hist.map(d=>d.ctr));
  const x = i => p + (i*(w-2*p))/Math.max(1,n-1);
  const y = (v,max) => h-p - (v/max)*(h-2*p);

  function poly(data, key, color){
    const pts = data.map((d,i)=>`${x(i)},${y(d[key], key==='ctr'?maxCtr:(key==='cliques'?maxClk:maxImp))}`).join(' ');
    const pl = document.createElementNS(svgNS,'polyline');
    pl.setAttribute('points', pts);
    pl.setAttribute('fill','none');
    pl.setAttribute('stroke', color);
    pl.setAttribute('stroke-width','2');
    return pl;
  }
  // grid
  for(let i=0;i<5;i++){
    const gy=document.createElementNS(svgNS,'line');
    gy.setAttribute('x1',p); gy.setAttribute('x2',w-p);
    const yy=p + i*(h-2*p)/4; gy.setAttribute('y1',yy); gy.setAttribute('y2',yy);
    gy.setAttribute('stroke','#2a2f3a'); gy.setAttribute('stroke-width','1');
    svg.appendChild(gy);
  }
  if(n>1){
    svg.appendChild(poly(hist,'impressoes','#6aa9ff'));
    svg.appendChild(poly(hist,'cliques','#7ee787'));
    svg.appendChild(poly(hist,'ctr','#ffb86b'));
  }
  box.innerHTML=''; box.appendChild(svg);
}

async function carregarDados(){
  try{
    const r = await fetch('./dados_oraculares.json',{cache:'no-store'});
    if(!r.ok) throw new Error('read json');
    const d = await r.json();
    setText('#impressoes', d.impressoes);
    setText('#cliques', d.cliques);
    setText('#ctr', d.ctr_medio+'%');
    setText('#posicao', d.posicao_media);

    const tb=document.querySelector('table');
    if(tb && tb.tBodies[0]){
      tb.tBodies[0].innerHTML=(d.paises||[]).map(p=>`<tr><td>${p.pais}</td><td>${p.impressoes}</td><td>${p.cliques}</td><td>${p.ctr}%</td></tr>`).join('');
    }
    drawTrend(d.historico||[]);
  }catch(e){ console.error('carregarDados',e); }
}

async function atualizar(){
  try{
    await fetch('/cgi-bin/oraculo_autonomo.py?ts='+Date.now(),{cache:'no-store'});
  }catch(e){ console.error('cgi', e); }
  await carregarDados();
}

document.addEventListener('DOMContentLoaded', ()=>{
  carregarDados();
  const btn=document.getElementById('btn-atualizar') || document.querySelector('button.btn, button');
  if(btn){ btn.onclick=(ev)=>{ ev.preventDefault(); atualizar(); }; }
});
</script>
